generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}


model Company {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  address   String?  // New field
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  people    Person[]
  config    Config?
  users     User[]
  tags      Tag[]
  emailTemplates EmailTemplate[]
}

model StoreRequest {
  id             Int      @id @default(autoincrement())
  companyName    String
  address        String?
  requesterName  String
  requesterEmail String
  status         String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Tag {
  id        Int      @id @default(autoincrement())
  name      String
  companyId Int
  company   Company  @relation(fields: [companyId], references: [id])
  people    Person[]
  emailTemplates EmailTemplate[]
  
  @@unique([name, companyId])
}

model EmailTemplate {
  id        Int      @id @default(autoincrement())
  companyId Int
  company   Company  @relation(fields: [companyId], references: [id])
  tagId     Int?     // Null means default template
  subject   String
  body      String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Note: We don't strictly enforce relation to Tag model here to allow flexible matching 
  // or we could add: tag Tag? @relation(...)
  // Let's keep it simple: we match by tag name or ID conceptually. 
  // Actually, linking to Tag ID is safer.
  tag       Tag?     @relation(fields: [tagId], references: [id])

  @@unique([companyId, tagId]) // Each tag (or default/null) has one template per company
}

model Person {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  birthdate DateTime
  role      String?  // Cargo / Função
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  companyId Int?
  company   Company? @relation(fields: [companyId], references: [id])
  tags      Tag[]
}

model Config {
  id            Int     @id @default(autoincrement())
  smtpHost      String  @default("smtp.office365.com")
  smtpPort      Int     @default(587)
  smtpUser      String  @default("")
  smtpPass      String  @default("")
  // Removed emailTemplate from here, moving to EmailTemplate model. 
  // Keeping it for backward compatibility or migration script might be needed.
  // actually, let's keep it as DEPRECATED or as a fallback if no EmailTemplate found?
  // Let's keep it to avoid breaking changes immediately, but we will migrate data.
  emailTemplate String  @default("Happy Birthday, {name}!") @db.Text
  updatedAt     DateTime @updatedAt
  companyId     Int?     @unique
  company       Company? @relation(fields: [companyId], references: [id])
}

model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  passwordHash String
  role         String   @default("USER") // 'USER' or 'ADMIN'
  createdAt    DateTime @default(now())
  companies    Company[]
}
